name: Run Tests Before Merge

on:
  push:
    branches:
      - dev
  pull_request:
    branches:
      - dev

jobs:
  e2e-tests:
    runs-on: ubuntu-latest

    services:
      mongo:
        image: mongo:latest
        ports:
          - 27017:27017

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '16'

      - name: Install dependencies
        run: npm install

      - name: Run E2E tests
        run: npm run test:e2e
        env:
          MONGO_URL: mongodb://localhost:27017/test
          JWT_SECRET: ${{ secrets.JWT_SECRET }}

- name: Create Pull Request to master
  if: ${{ success() }}
  uses: actions/github-script@v6
  with:
    script: |
      const owner = context.repo.owner;
      const repo = context.repo.repo;

      // Check if there is already an open PR from dev to master
      const pullRequests = await github.rest.pulls.list({
        owner: owner,
        repo: repo,
        head: "dev",
        base: "master",
        state: "open",
      });

      if (pullRequests.data.length === 0) {
        // Create a new pull request
        await github.rest.pulls.create({
          owner: owner,
          repo: repo,
          title: "Auto PR: Merge dev into master",
          head: "dev",
          base: "master",
          body: "This PR was automatically created by GitHub Actions upon passing tests in the dev branch.",
        });
      } else {
        console.log("An open pull request from dev to master already exists.");
      }

